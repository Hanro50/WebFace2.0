<!DOCTYPE html>
<html>

<head>
    <style>
        #header {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1 id="header">Page editor\nLoading...</h1>
    <hr>
    <div class="button" onclick="window.location.href='./socket.html'">Back</div>
    <script type="module">
        function button(text, func) {
            const div = document.createElement("div");
            div.classList = "button";
            div.onclick = func;
            div.innerText = text;
            document.body.appendChild(div);
            return div;
        }
        const domain = new URL(location.href).searchParams.get('domain')
        const header = document.getElementById("header");
        const r65 = await fetch("/api/ports/info?domain=" + domain);
        if (!r65.ok) header.innerText = `Error ${r65.status}\n${await r65.text()}`;
        else {
            /**@type {{domain: string,
    redirect: string,cloudflare?: boolean,open?: boolean,name?: string}}*/
            const dns = await r65.json();
            header.innerText = `Page editor\n"http://${dns.domain}/"=>"http://${dns.redirect}/"`

            button("Delete this redirect", async () => {
                document.body.innerText = "Deleting endpoint..."
                const r77 = await fetch("/api/ports/remove", { method: "post", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ domain }) });
                if (!r77.ok) {
                    alert(`Failed to delete redirect due to \n${r77.status}: ${await r77.text()} `)
                }
                window.location.href = './socket.html';
            })

            button(!dns.name ? "Name this redirect" : "Rename " + dns.name, async () => {
                const name = prompt("Please enter a new name for this redirect", dns.name ? dns.name : "");
                if (!name) return
                document.body.innerText = "Renaming endpoint..."
                const r89 = await fetch("/api/ports/name", { method: "post", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ domain, name }) });
                if (!r89.ok) alert(`Failed to rename this redirect due to \n${r89.status}: ${await r.text()} `)
                window.location.reload();
            })

            if (dns.name) {
                button(dns.open ? "Hide this redirect" : "Show this redirect", async () => {
                    document.body.innerText = dns.open ? "Hiding this redirect" : "Unhiding this redirect";
                    const r44 = await fetch("/api/ports/toggle", { method: "post", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ domain }) });
                    if (!r44.ok) alert(`Failed to ${dns.open ? "Hide" : "Show"} this redirect due to \n${r44.status}: ${await r.text()} `)
                    window.location.reload();
                }).title = "To do with the 404 error page"
            }
        }
    </script>
</body>

</html>